# =========================================
# ğŸš€ Terraform Lab 3 - VPC + EC2 + RDS
# =========================================

# Variabili (modifica con i propri dati)
KEY_PATH=
REGION=
USER=

# Output (verrÃ  popolato dopo apply)
BASTION_IP=$(shell terraform output -raw bastion_public_ip 2>/dev/null)
RDS_ENDPOINT=$(shell terraform output -raw rds_endpoint 2>/dev/null)

# =========================================
# ğŸ”§ 1. Inizializzazione Terraform
# =========================================
init:
	terraform init

# =========================================
# ğŸ§© 2. Creazione del piano
# =========================================
plan:
	terraform plan

# =========================================
# ğŸš€ 3. Deploy completo dell'infrastruttura
# =========================================
apply:
	terraform apply -auto-approve

# =========================================
# ğŸ” 4. Mostra gli output
# =========================================
output:
	terraform output

# =========================================
# ğŸ§  5. Connessione SSH al Bastion Host
# =========================================
connect-bastion:
	@if [ -z "$(BASTION_IP)" ]; then \
		echo "âŒ Bastion IP non trovato. Esegui prima 'make output'"; \
	else \
		echo "ğŸ” Connessione a Bastion: $(BASTION_IP)"; \
		chmod 400 $(KEY_PATH); \
		ssh -i $(KEY_PATH) $(USER)@$(BASTION_IP); \
	fi

# =========================================
# ğŸ§± 6. Tunnel SSH per accedere a RDS
# =========================================
tunnel-rds:
	@if [ -z "$(BASTION_IP)" ] || [ -z "$(RDS_ENDPOINT)" ]; then \
		echo "âŒ Devi prima eseguire 'make apply' e 'make output' per ottenere gli endpoint."; \
	else \
		echo "ğŸŒ‰ Creazione tunnel SSH verso RDS..."; \
		echo "Comando attivo: ssh -i $(KEY_PATH) -L 3306:$(RDS_ENDPOINT):3306 $(USER)@$(BASTION_IP)"; \
		ssh -i $(KEY_PATH) -L 3306:$(RDS_ENDPOINT):3306 $(USER)@$(BASTION_IP); \
	fi

# =========================================
# ğŸ§ª 7. Test connessione MySQL (dopo tunnel)
# =========================================
mysql-test:
	mysql -h 127.0.0.1 -P 3306 -u admin -p

# =========================================
# ğŸ’£ 8. Distruzione completa
# =========================================
destroy:
	terraform destroy -auto-approve

# =========================================
# ğŸ“Š 9. Monitoraggio e logs
# =========================================
logs:
	@echo "ğŸ“ˆ Apri AWS CloudWatch per vedere metriche EC2/RDS"
	@echo "ğŸ” Puoi attivare i VPC Flow Logs nella console VPC"

# =========================================
# ğŸ§¹ 10. Pulizia file locali
# =========================================
clean:
	rm -rf .terraform terraform.tfstate* .terraform.lock.hcl
	@echo "ğŸ§¹ Pulizia completata."
